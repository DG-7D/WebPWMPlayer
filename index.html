<!DOCTYPE html>
<html lang="ja">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <title>PWM再生器</title>
    </head>

    <body>
        <h1>PWM再生器</h1>
        <div>
            <label>周波数</label> <input type="number" id="freq" value="50" min="20" max="20000" step="10"> Hz,
            <label>波長</label> <input type="number" id="lambda" value="20000" min="50" max="50000" readonly> μs
        </div>
        <div>
            <label>デューティー比</label><input type="number" id="duty" value="7.5" min="0" max="100" step="0.5"> %,
            <label>パルス幅</label> <input type="number" id="pulse" value="1500" min="0" max="50000" readonly> μs
        </div>
        <div>
            <label>右側を反転させる</label> <input type="checkbox" id="invert">
        </div>
        <div>
            <button id="toggle">再生</button>
        </div>

        <script>
            let freq = 50;
            let duty = 7.5;
            let invert = false;

            document.getElementById("freq").addEventListener("input", (e) => {
                freq = Number(e.target.value);
                updateBuffer();
            });
            document.getElementById("duty").addEventListener("input", (e) => {
                duty = Number(e.target.value);
                updateBuffer();
            });
            document.getElementById("invert").addEventListener("input", (e) => {
                invert = e.target.checked;
                updateBuffer();
            });
            document.getElementById("toggle").addEventListener("click", (e) => {
                if (e.target.textContent === "再生") {
                    play();
                    e.target.textContent = "停止";
                } else {
                    stop();
                    e.target.textContent = "再生";
                }
            });

            const audioContext = new AudioContext();
            audioContext.suspend();
            let source;
            updateBuffer();

            function updateBuffer() {
                document.getElementById("lambda").value = (1 / freq * 1000000).toFixed(0);
                document.getElementById("pulse").value = (1 / freq * 1000000 * duty / 100).toFixed(0);

                source?.stop();
                source?.disconnect();

                const loopLength = Math.floor(audioContext.sampleRate / freq);
                const buffer = new AudioBuffer({
                    length: loopLength,
                    numberOfChannels: invert ? 2 : 1,
                    sampleRate: audioContext.sampleRate,
                });
                buffer.getChannelData(0).fill(1).fill(-1, loopLength * duty / 100);
                invert && buffer.getChannelData(1).fill(-1).fill(1, loopLength * duty / 100);
                source = new AudioBufferSourceNode(audioContext, { buffer: buffer, loop: true });
                source.connect(audioContext.destination);
                source.start();
            }
            function play() {
                audioContext.resume();
            }
            function stop() {
                audioContext.suspend();
            }
        </script>
    </body>

</html>